<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.0.0"
           xsi:schemaLocation="
             http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
             http://camel.apache.org/schema/blueprint/cxf http://camel.apache.org/schema/blueprint/cxf/camel-cxf.xsd
             http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">
    
    <cm:property-placeholder persistent-id="it.imolinfo.maven.plugins.samples">
        <cm:default-properties>
            <!-- cfg/it.imolinfo.maven.plugins.samples.cfg -->
        </cm:default-properties>
    </cm:property-placeholder>
    
    <cxf:cxfEndpoint xmlns:s="http://ws.camelCmisSample.imolinfo.it/v1"
                     id="camelCmisSampleEndpoint"
                     address="/camelCmisSample_v1"
                     endpointName="s:camelCmisSampleSoap_v1"
                     serviceName="s:camelCmisSample_v1"
                     serviceClass="it.imolinfo.camelcmissample.ws.v1.CamelCmisSampleV1"
                     wsdlURL="wsdl/CamelCmisSample_v1.wsdl">
        <cxf:properties>
            <entry key="schema-validation-enabled" value="true" />
            <entry key="mtom-enabled" value="true" />
        </cxf:properties>
    </cxf:cxfEndpoint>  
    
    <bean class="it.imolinfo.maven.plugins.samples.CreateDocumentsAggregationStrategy" id="createDocumentsAggregationStrategy"/>
    
    <camelContext id="camelCmis" xmlns="http://camel.apache.org/schema/blueprint" streamCache="true" allowUseOriginalMessage="false">
        
        <route id="camelCmisSampleEndpointRoute_v1">
            <from uri="cxf:bean:camelCmisSampleEndpoint"/>
            <log message="Start ${in.header.operationName}" loggingLevel="INFO"/>
            <choice>
                <when id="createDocuments">
                    <simple>${in.header.operationName} == 'createDocuments'</simple>
                    <setBody>
                        <simple>${body[0]}</simple>
                    </setBody>
                    <to uri="direct:createDocumentsRouteDirect_v1"/>
                </when>
            </choice>
        </route>
        
        <route id="createDocumentsRouteDirect_v1">
            <from uri="direct:createDocumentsRouteDirect_v1"/>
            <split strategyRef="createDocumentsAggregationStrategy" stopOnException="true" >
                <simple>${body.getDocuments()}</simple>
                <setProperty propertyName="documentName">
                    <simple>${body.getDocumentName()}</simple>
                </setProperty>
                <setHeader headerName="cmis:contentStreamMimeType">
                    <simple>${body.getDocumentContentType()}</simple>
                </setHeader>
                <setHeader headerName="cmis:name">
                    <simple>${body.getDocumentName()}</simple>
                </setHeader>
                <setHeader headerName="CamelCMISFolderPath">
                    <simple>${body.getFolderPath()}</simple>
                </setHeader>
                <setHeader headerName="cmis:objectTypeId">
                    <simple>${body.getDocumentClass()}</simple>
                </setHeader>
                <setBody>
                    <simple>${body.getDocumentFile().getInputStream()}</simple>
                </setBody>
                <recipientList>
                    <simple>cmis://{{cmis.server}}?username={{cmis.user}}&amp;password={{cmis.passwd}}&amp;repositoryId={{cmis.repoId}}</simple>
                </recipientList>
            </split>
            <log message="${body.getClass().getName()}" loggingLevel="INFO"/>

        </route>
        
    </camelContext>
</blueprint>
